{% extends "layout.html" %}

{% block title %}Sign In - NumeriLogic{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 py-12 px-4 sm:px-6 lg:px-8 flex items-center justify-center">
  <div class="w-full max-w-md">
    <!-- Login Card -->
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white px-8 py-12">
        <div class="text-center mb-6">
          <div class="inline-block bg-white bg-opacity-20 rounded-lg p-3 backdrop-blur mb-4">
            <i class="fas fa-sign-in-alt text-4xl"></i>
          </div>
        </div>
        <h1 class="text-3xl font-bold text-center">Welcome Back</h1>
        <p class="text-indigo-100 text-center mt-2">Sign in to your NumeriLogic account</p>
      </div>

      <!-- Form -->
      <div class="px-8 py-10">
        <!-- Alerts -->
        <div id="errorAlert" class="hidden mb-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg" role="alert">
          <p class="font-bold text-sm">Error</p>
          <span id="errorMessage" class="block text-sm"></span>
        </div>

        <div id="successAlert" class="hidden mb-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-r-lg" role="alert">
          <p class="font-bold text-sm">Success</p>
          <span id="successMessage" class="block text-sm"></span>
        </div>

        <form id="loginForm" class="space-y-6" onsubmit="return false;">
          <!-- Username Field -->
          <div>
            <label for="username" class="block text-sm font-bold text-gray-700 mb-2">
              <i class="fas fa-user text-indigo-600 mr-2"></i>Username
            </label>
            <input type="text" id="username" name="username" required
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                   placeholder="Enter your username">
          </div>

          <!-- Password Field -->
          <div>
            <label for="password" class="block text-sm font-bold text-gray-700 mb-2">
              <i class="fas fa-lock text-indigo-600 mr-2"></i>Password
            </label>
            <input type="password" id="password" name="password" required
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                   placeholder="Enter your password">
          </div>

          <!-- Remember Me -->
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <input id="remember" name="remember" type="checkbox" 
                     class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
              <label for="remember" class="ml-2 block text-sm text-gray-700 font-medium">Remember me</label>
            </div>

            <div class="text-sm">
              <a href="#" class="font-semibold text-indigo-600 hover:text-indigo-800 transition">
                Forgot password?
              </a>
            </div>
          </div>

          <!-- Submit Button -->
          <button type="submit" 
                  class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:shadow-lg text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-105 flex items-center justify-center space-x-2">
            <i class="fas fa-sign-in-alt"></i>
            <span>Sign In</span>
          </button>
        </form>

        <!-- Divider -->
        <div class="relative my-6">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-white text-gray-500">Don't have an account?</span>
          </div>
        </div>

        <!-- Register Link -->
        <a href="/register" class="w-full block text-center bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg transition">
          <i class="fas fa-user-plus mr-2"></i>Create New Account
        </a>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-8 py-4 border-t border-gray-200 text-center text-xs text-gray-600">
        <p>Welcome to NumeriLogic - Your Advanced Calculation Platform</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('loginForm');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const successAlert = document.getElementById('successAlert');
    const successMessage = document.getElementById('successMessage');

    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('hidden');
        successAlert.classList.add('hidden');
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        successAlert.classList.remove('hidden');
        errorAlert.classList.add('hidden');
    }

    function storeTokens(tokenData) {
        localStorage.setItem('access_token', tokenData.access_token);
        localStorage.setItem('refresh_token', tokenData.refresh_token);
        localStorage.setItem('token_expires', tokenData.expires_at);
        localStorage.setItem('user_id', tokenData.user_id);
        localStorage.setItem('username', tokenData.username);
        localStorage.setItem('email', tokenData.email);
        localStorage.setItem('first_name', tokenData.first_name);
        localStorage.setItem('last_name', tokenData.last_name);
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        errorAlert.classList.add('hidden');
        successAlert.classList.add('hidden');

        const formData = {
            username: form.username.value.trim(),
            password: form.password.value
        };

        if (!formData.username || !formData.password) {
            showError('Please fill in all fields');
            return;
        }

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Login failed');
            }

            storeTokens(data);

            if (form.remember.checked) {
                localStorage.setItem('remember_login', 'true');
                localStorage.setItem('remembered_username', formData.username);
            } else {
                localStorage.removeItem('remember_login');
                localStorage.removeItem('remembered_username');
            }

            showSuccess('Login successful! Redirecting...');

            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);

        } catch (error) {
            showError(error.message || 'Invalid username or password');
        }
    });

    if (localStorage.getItem('remember_login') === 'true') {
        const rememberedUsername = localStorage.getItem('remembered_username');
        if (rememberedUsername) {
            form.username.value = rememberedUsername;
            form.remember.checked = true;
        }
    }
});
</script>
{% endblock %}